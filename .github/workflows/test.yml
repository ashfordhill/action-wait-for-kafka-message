name: CI
on:
  push:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      kafka:
        image: confluentinc/confluent-local:7.6.0
        ports:
          - 9092:9092
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Background Producer
        run: |
          # Wait for Kafka to be ready, then wait a bit more for the action to start, then produce
          (
            echo "Waiting for Kafka to be ready..."
            # Simple wait for port
            timeout 60s bash -c 'until printf "" 2>>/dev/null >/dev/tcp/localhost/9092; do sleep 1; done'
            echo "Kafka is up, waiting 15s for the action to start listening..."
            sleep 15
            echo "Producing message..."
            echo "test-message" | docker run --rm -i --network host confluentinc/cp-kafka:7.6.0 kafka-console-producer --bootstrap-server localhost:9092 --topic test-topic
            echo "Message produced."
          ) &

      - name: Wait for Kafka Message
        uses: ./
        with:
          bootstrap_servers: 'localhost:9092'
          topic: 'test-topic'
          message_count: 1
          timeout_ms: 60000
