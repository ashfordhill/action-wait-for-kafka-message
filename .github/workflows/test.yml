name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      kafka:
        image: bitnami/kafka:3.7
        ports:
          - 9092:9092
        env:
          KAFKA_CFG_NODE_ID: 0
          KAFKA_CFG_PROCESS_ROLES: controller,broker
          KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
          KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
          KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@kafka:9093
          KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
          ALLOW_PLAINTEXT_LISTENER: yes
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        continue-on-error: true # In case there is no build script yet

      - name: Background Producer
        run: |
          # Wait for Kafka to be ready, then wait a bit more for the action to start, then produce
          (
            echo "Waiting for Kafka to be ready..."
            timeout 60s bash -c 'until printf "" 2>>/dev/null >/dev/tcp/localhost/9092; do sleep 1; done'
            echo "Kafka is up, waiting 10s for the action to start listening..."
            sleep 10
            echo "Producing message..."
            echo "test-message" | docker run --rm -i --network host confluentinc/cp-kafka:latest kafka-console-producer --bootstrap-server localhost:9092 --topic test-topic
            echo "Message produced."
          ) &

      - name: Wait for Kafka Message
        uses: ./
        with:
          bootstrap_servers: 'localhost:9092'
          topic: 'test-topic'
          message_count: 1
          timeout_ms: 60000
